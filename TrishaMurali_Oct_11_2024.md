Name: Trisha Murali <br/>
Date: 10/11/2024

# STM32 Updates 
No parts came in yet, so we continued to work on PCBs and I worked on more specifics related to the STM32 <br/>

Firstly, as my group and I have been waiting for our PCB orders to get here (which we placed by the first week), I have been working with the lab-provided STM32 Nucleo board (F103RB). As an effort to get the setup correct, I set up LD2 (green LED) to blink using the HAL driver setup and a delay [2]. This was done using the HAL_Init() in the main function of the codebase to initialize the driver to eventually set up/toggle and delay the blinking of the LED using the HAL_GPIO_TogglePin() and the HAL_Delay() functions inside a while loop. The exact GPIO and pins can be inputted in the HAL_GPIO_TogglePin() function and the delay accounts for the milliseconds in between turning the LED on and off, causing it to blink. In this case, I experimented with using between a 100 to a 1000. 

From here, I worked with the servo motor (HS-311). This has 3 wires, yellow, black and red. This color coding is a clear indication of the use cases. The black and red are power and ground while the yellow one can be wired to the STM32 Nucleo board. This yellow wired connection is what reacts to the HIGH/LOW signal. For testing purposes, this was wired to the A0 pin. In terms of communicating with the servo motor, a few things had to be set up on the CubeIDE: the clock settings as well as the code. The operating voltage for the HS-311 is 4.8V-6.0V. The breadboard to which the motor was connected and the STM32 both use the same ground and power lines to establish that connection. The STM32 board has a 5V and GND which are wired into the breadboard’s ground and power (also shared by the motor). Servo motors generally have 180 degrees of movement (rotation).

As for the clock configuration (shown in Figure 2), approximately 45 MHz is required. For testing purposes [3], TIM2 was set up as part of the timers configuration/category. The associated peripheral for this timer is APB1 (Advanced Peripheral Bus 1) Timer Clock. Achieving an exact 45 MHz in the NUCLEO-F103RB’s clock configuration threw some warnings. When 45 MHz was input, it said that there are no appropriate values for the other fields leading up to APB1. As can be seen, the PLL Source Multiplexer uses HSE (High Speed External Oscillator), one of the clock source resonator options [4] that provides a more accurate signal and is better for reaction purposes/precise requirements for The Smart Plant Pot [5]. There was an alternate solution for 44 MHz and 48 MHz. Since 45 MHz was the required number, 48 was used. This changes the PLL (phase-locked loop) to 8 and the PLLMul to times 6, giving us 48 through the PLLCLK (in the System Clock Mux). This outputs 48 MHz in the SYSCLK and we have already reached this value so there is no prescaler division necessary. This puts us at 48 MHz HCLK which helps determine the APB1 peripheral clock and timer clock value. Ultimately, the APB1 timer clock value is where the 45 MHz approximate value is needed, so we try to maintain that 48 MHz value as shown in Figure 2. As for the TIM2 Mode and Configuration, the clock source was set to internal clock and Channel 1 is set to PWM (Pulse Width Modulation) Generation CH1. The parameter settings are also modified to match the requirements (Counter Period – AutoReload Register/Prescaler). These settings along with the 48 MHz play a role in determining the frequency necessary. The pulse values in code will allow for different degrees of rotation. In this case, I attempted 3 rotations (0 degrees, 90 degrees, and 180 degrees) by ensuring that the pulse values match up with the formula that the clock/parameter settings work with [3]. 

![image](https://github.com/user-attachments/assets/0c309504-dbae-4621-8f2a-8c4821348e64)

Let’s say a pulse width of 1.5 ms had to be reached, the AutoReload Register value plays a vital role in determining this [3].  
The PA0 pin, with the yellow wire of the HS-311 has the mapping of the TIM2_CH1. As for the code setup itself (main.c), the file defaults to including the HAL_Init() when the code is generated. When generating code based on the pinout/clock configuration and settings, there are STM32F1xx_HAL_Driver files and functions that are autofilled. Looking at the stm32f1xx_hal_tim.h files, there is a definition for the HAL_TIM_PWM_Start() function taking in the timer and channel. From the previous setup for the servo motor, TIM2 and Channel 1 were passed in. The TIM2 has a struct defined with capture/compare registers. In the case of setting pulse width values, TIM2’s CCR1 was used to allow for the 3 rotations. For the purposes of The Smart Plant Pot, the servo motor is used to open the vents. This is a key mechanism of the humidity subsystem along with some overlap from the oxygenation, grow lights subsystem. The application of the testing I performed with the servo motor is transferable to the applications of our project’s design. Our CAD design has a servo fixed onto it and 3 different rotation settings are sufficient to account for air circulation and maintain humidity levels. Any angles, if necessary, can be calculated using the formula above, but the three mentioned should be a good baseline to work with. 

References: <br/>
[1] “Nutrient and pH Chart for Growing Fruits and Vegetables with Hydroponics”, IGWorks, https://igworks.com/blogs/growing-guides/nutrient-and-ph-chart-for-growing-hydroponic-fruits-and-vegetables <br/>
[2] “STM32StepbyStep”, Blink2LED, Jan. 2024. https://wiki.st.com/stm32mcu/wiki/STM32StepByStep:Step2_Blink_LED <br/>
[3] “How to Interface Servo motor with STM32”, Controller’s Tech, https://controllerstech.com/servo-motor-with-stm32/ <br/>
[4] “Part 1: Introduction to the STM32 microcontroller clock system”, March. 2024. https://community.st.com/t5/stm32-mcus/part-1-introduction-to-the-stm32-microcontroller-clock-system/ta-p/605369 <br/>
[5] “HSI vs HSE Clock in an STM32F4xx Microcontroller Board-Explained”, Learning about Electronics, 2018, https://www.learningaboutelectronics.com/Articles/HSI-vs-HSE-clock-in-an-STM32F4xx-microcontroller.php <br/>
